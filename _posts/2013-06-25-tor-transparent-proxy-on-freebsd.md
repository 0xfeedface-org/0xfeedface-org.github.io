---
layout: post
title: Tor Transparent Proxy on FreeBSD
created: 1372197540
---
<p>For a while now, I've been wanting to set up a PF-based firewall that transparently proxies everything over Tor. I've also wanted to help the Tor project out and run a relay. I don't want to take the risk of running an exit node (and getting banned from all sorts of services I actively use). Since I love FreeBSD, I decided to try my luck setting this up on this fantastic OS. To do a test run prior to wider deployment, I set up transparent tor proxying on my netbook and created a little script to turn off and on the proxy. This article will show you how to do the same. The official wiki-based <a href="https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy" target="_blank">documentation</a> will give you a basic understanding of what to do. Their example scripts don't seem to work that great on FreeBSD 9-STABLE.</p><p><span style="font-size: medium;"><strong>DNS</strong></span></p><p>When the transparent proxy is enabled, DNS requests will be forwarded over to tor. We need to be able to handle behind-the-scenes switching from regular DNS to DNS-over-tor. We'll set up named to listen on 127.0.0.1 and forward DNS requests to an upstream provider (we'll use Google's DNS server, 8.8.8.8, as an example). In <code>/etc/namedb/named.conf</code>, you'll see these commented-out lines: <code> forwarders { 127.0.0.1; };</code> Change that to be: <code> forwarders { 8.8.8.8; };</code>Enable and start named:</p><ul><li>Enable named in <code>/etc/rc.conf</code>:<ul><li><code> echo 'named_enable="YES"' &gt;&gt; /etc/rc.conf</code></li></ul></li><li>Start named:</li><ul><li><code>service named start</code></li></ul><li>Make it so that we always use 127.0.0.1 as our nameserver. This assumes you're using dhclient:</li><ul><li>echo "supersede domain-name-servers 127.0.0.1;" &gt; /etc/dhclient.conf</li></ul></ul><p><span style="font-size: medium;"><strong>Network Interfaces</strong></span></p><p>We'll have tor run its own DNS server on lo1, which will have an IP of 127.0.0.2. Our PF rules will forward DNS requests to tor. So let's create a new loopback interface and set its IP to 127.0.0.2:</p><blockquote><p>echo 'cloned_interfaces="lo1"' &gt;&gt; /etc/rc.conf</p><p>echo 'ifconfig_lo1="127.0.0.2"' &gt;&gt; /etc/rc.conf</p></blockquote><p><span style="font-size: medium;"><strong>Configuring Tor</strong></span></p><p>Install security/tor via your favorite method (ports, pkg_add, pkgng). So let's now configure Tor. We'll set it up so that it creates is own virtual network (all in memory) for DNS requests. We'll configure it so that it listens for DNS on port 1053. Normally, you'd configure it so that it listens on port 53, but there are two problems with that. First, named is listening on port 53 already. Second, Tor drops root privileges prior to setting up the DNS server socket, so Tor can't bind to port 53. The official documentation doesn't address the second problem.</p><p>Here's my /usr/local/etc/tor/torrc file:</p><blockquote><p>VirtualAddrNetwork 10.192.0.0/10</p><p>AutomapHostsOnResolve 1</p><p>TransPort 9040</p><p>DNSPort 1053</p></blockquote><p><span style="font-size: medium;"><strong>Setting Up PF</strong></span></p><p>Tor will need access to the /dev/pf device. In a display of awesome stupidity, Tor attempts to access the device after dropping root privileges. So we'll add an entry to /etc/devfs.conf to set the _tor user to own /dev/pf.</p><p>To add the rule to add the entry in /etc/devfs.conf:</p><blockquote><p>echo 'own pf _tor:_tor' &gt;&gt; /etc/devfs.conf</p></blockquote><p>I placed in a file on my home directory (which I called pf.conf) the following ruleset:</p><blockquote><p>int_if = "wlan0"</p><p>&nbsp;</p><p># Don't use tor for the local network</p><p>non_tor = "{ 192.168.1.0/24 }"</p><p>&nbsp;</p><p>trans_port = "9040"</p><p>&nbsp;</p><p>scrub in</p><p>&nbsp;</p><p>rdr pass on { lo1 $int_if } inet proto tcp to !($int_if) -&gt; 127.0.0.1 port $trans_port</p><p>rdr pass on lo0 inet proto udp to port domain -&gt; 127.0.0.1 port 1053</p><p>&nbsp;</p><p># Don't use tor for ssh'ing into my box</p><p>pass out quick inet proto tcp to 0xfeedface.org port 22 keep state</p><p>&nbsp;</p><p>block return out</p><p>pass quick on { lo0 lo1 } keep state</p><p>&nbsp;</p><p>pass out quick inet proto tcp user _tor flags S/SA modulate state</p><p>pass out quick route-to lo1 inet proto udp to port 1053 keep state</p><p>pass out quick inet to $non_tor keep state</p><p>pass out route-to lo1 inet proto tcp all flags S/SA modulate state</p></blockquote><p>You will want to change int_if to your ethernet device. You'll also want to change non_tor to the subnet for your local network. That's it! You can enable the tor transparent proxy by executing: pfctl -e -f /path/to/pf.conf. You can disable the tor transparent proxy by executing: pfctl -d.</p><p>You can find the script and pf configuration file I use on <a href="https://github.com/lattera/transtor" target="_blank" title="GitHub">GitHub</a>.</p>
